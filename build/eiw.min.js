/*!
 * obelisk.js 0.0.1
 * https://github.com/vincentdesmares/eiw
 * MIT licensed
 *
 * Copyright (C) 2014 Vincent Desmares https://github.com/vincentdesmares
 */
Eiw={classes:{},page:{},template:{},Widget:{Plugin:{Bootstrap:{}}},Prefab:{Widget:{Bootstrap:{}}},Application:{},CreateWidget:function(a){return this.classes[a]=function(){this.id="city-map",this.api="/frontoffice/city/json/id/1/"},$.extend(!0,this.classes[a].prototype,new Eiw.Widget.Abstract),this.classes[a]},InstantiateWidget:function(a){return new this.classes[a]}},function(){"use strict";var a;a=function(){},a.prototype.bootstrap=function(){},a.prototype.log=function(a){return console.log(a),this},Eiw.logger=a}(),function(){"use strict";var a;a=function(a){this.application=a},a.prototype.bootstrap=function(){$.address.autoUpdate(!1)},a.prototype.bindApplicationToUrl=function(){var a=this;$.address.externalChange(function(){a.handleUrlChange(!1)}),$.address.internalChange(function(){a.handleUrlChange(!0)})},a.prototype.handleUrlChange=function(a){this.log(a===!0?"Address changing by internal action":"Address changing by external action");var b=this.getPath();if(this.log("State :"+b),this.log("Parameters:"+$.address.parameterNames().join(",")),void 0!=b){var c=this.getPageMatchingPath(b);null!=c?(this.log("Page matching: "+c.getId()),this.getApp().pages.setCurrentPage(c.getId())):(this.log("No page are matching the current state:"+b),alert("404, fail, bouuu"))}else this.log("No path in the url, default page will be loaded");this.getApp().isLoaded()?this.getApp().pages.getCurrentPage().load():this.getApp().load()},a.prototype.getPath=function(){return $.address.state()||window.location.pathname.slice(0,-1)},a.prototype.getPageMatchingPath=function(a){var b=null;return $.each(this.getApp().pages.getAll(),function(c,d){var e=d.getRoute();new RegExp(e).test(a)&&(b=d)}),b},a.prototype.setPath=function(a){return $.address.state(a),this.savePageState(),this},a.prototype.savePageState=function(){return $.address.update(),this},a.prototype.getApp=function(){return this.application},a.prototype.log=function(a){this.getApp().log("#router: "+a)},Eiw.router=a}(),function(){"use strict";var a;a=function(){this.id=null,this.url=null,this.content=null},a.prototype.bootstrap=function(){},a.prototype.getId=function(){return this.id},a.prototype.getHtml=function(){return this.content},a.prototype.load=function(a){var b=this;$.get(this.url,function(c){b.content=c,a()})},Eiw.template.Abstract=a}(),function(){"use strict";var a;a=function(){this.templates={},this.currentTemplateId=null},a.prototype.bootstrap=function(){},a.prototype.get=function(a){throw $.each(this.templates,function(b,c){return c.getId()==a?widget:void 0}),"widget not found"},a.prototype.add=function(a){null==this.currentTemplateId&&(this.currentTemplateId=a.getId()),this.templates[a.getId()]=a},a.prototype.getCurrentTemplate=function(){if(null==this.currentTemplateId)throw"No template loaded for this object";return this.templates[this.currentTemplateId]},Eiw.template.container=a}(),function(){"use strict";var a;a=function(a,b){void 0===b&&(b=a),this.id=b,this.url=a},$.extend(!0,a.prototype,new Eiw.template.Abstract),a.prototype.bootstrap=function(){},a.prototype.getHtml=function(a){return Handlebars.compile(this.content)(a.getData())},Eiw.template.handlebar=a}(),function(){"use strict";var a;a=function(){this.id=null,this.templates=null,this.replaceNode=!1,this.application=null,this.api=null,this.data={},this.loaded=!1,this.configuration=null,this.types={},this.types.widget="widget",this.types.page="page",this.types.application="application"},a.prototype.setApplication=function(a){this.application=a},a.prototype.initTemplateManager=function(){null==this.templates&&(this.templates=new Eiw.template.container)},a.prototype.bootstrap=function(){this.initTemplateManager(),this.configuration=new Eiw.Widget.Configuration},a.prototype.getId=function(){return this.id},a.prototype.getType=function(){return Eiw.Widget.types.widget},a.prototype.getJqueryNode=function(){var a=$(this.getNodeId());if(0==a.length)throw"A widget have no node found: "+this.getId();return a},a.prototype.hasJqueryNode=function(){var a=$(this.getNodeId());return 0==a.length?!1:!0},a.prototype.getNodeId=function(){return"#"+this.getId()},a.prototype.load=function(){this.onPreLoad();var a=this.templates.getCurrentTemplate(),b=new Eiw.Application.Promise,c=this;return a.load(function(){if(c.hasApi()){var a=c.getNewRequest(b);c.getApp().requestServer(a)}else c.onPreRender(),c.render(function(){c.loaded=!0,b.callSuccess()})}),b},a.prototype.getNewRequest=function(a){var b=this;return new Eiw.Application.request(this.getApi(),function(c){b.onPostApiRequest()!==!1&&(b.data=c.getContent(),b.log("Data loaded"),b.onPreRender(),b.render(function(){a.callSuccess()}))})},a.prototype.hasApi=function(){return null!==this.api},a.prototype.getApi=function(){return this.api},a.prototype.getData=function(){return this.data},a.prototype.setData=function(a){return this.data=a,this},a.prototype.hasData=function(){return this.data.length>0?!0:!1},a.prototype.render=function(a){this.log("Rendering"),this.replaceNode===!0?this.getJqueryNode().replaceWith(this.templates.getCurrentTemplate().getHtml(this)):this.getJqueryNode().html(this.templates.getCurrentTemplate().getHtml(this)),this.onPostRender()!==!1&&void 0!=a&&a()},a.prototype.getApp=function(){return this.application},a.prototype.log=function(a){this.getApp().log("#"+this.getId()+":"+a)},a.prototype.isLoaded=function(){return this.loaded},a.prototype.extend=function(a){$.extend(!0,this.prototype,a)},a.prototype.getConfiguration=function(){return this.configuration},a.prototype.onPostBootstrap=function(){},a.prototype.onPostApiRequest=function(){},a.prototype.onPreLoad=function(){},a.prototype.onPreRender=function(){},a.prototype.onPostRender=function(){},Eiw.Widget.Abstract=a}(),function(){"use strict";var a;a=function(){this.data={}},a.prototype.getValue=function(a){var b=null,c=!1;if($.each(this.data,function(d,e){return d==a?(b=e,c=!0,!1):void 0}),c)return b;throw"Configuration key not found : ["+a+"]"},a.prototype.setValue=function(a,b){return this.data[a]=b,this},a.prototype.getAllAsArray=function(){return this.data},Eiw.Widget.Configuration=a}(),function(){"use strict";var a;a=function(a){this.application=a,this.widgets={}},a.prototype.bootstrap=function(){$.each(this.widgets,function(a,b){b.bootstrap(),b.onPostBootstrap()})},a.prototype.get=function(a){var b=null;if($.each(this.widgets,function(c,d){d.getId()==a&&(b=d)}),null!=b)return b;throw"widget not found"},a.prototype.add=function(a){return a.setApplication(this.getApplication()),this.widgets[a.getId()]=a,this},a.prototype.getApplication=function(){return this.application},Eiw.Widget.container=a}(),function(){"use strict";var a;a=function(){this.route="",this.widgets=null},$.extend(!0,a.prototype,new Eiw.Widget.Abstract),a.prototype.bootstrap=function(){this.widgets=new Eiw.Widget.container(this.getApp()),Eiw.Widget.Abstract.prototype.bootstrap.call(this)},a.prototype.getNodeId=function(){return"#page-container"},a.prototype.isMatchingUrlPath=function(){return!0},a.prototype.getRoute=function(){return this.route},a.prototype.getType=function(){return Eiw.Widget.types.page},Eiw.page.Abstract=a}(),function(){"use strict";var a;a=function(a){this.application=a,this.pages={},this.currentPageId=null},a.prototype.bootstrap=function(){$.each(this.pages,function(a,b){b.bootstrap(),b.onPostBootstrap(),b.widgets.bootstrap()})},a.prototype.get=function(a){var b=null;if($.each(this.pages,function(c,d){d.getId()==a&&(b=d)}),null!=b)return b;throw"page not found"},a.prototype.getAll=function(){return this.pages},a.prototype.add=function(a){return null==this.currentPageId&&(this.currentPageId=a.getId()),a.setApplication(this.getApplication()),this.pages[a.getId()]=a,this},a.prototype.getCurrentPage=function(){if(null==this.currentPageId)throw"No page loaded in the application";return this.pages[this.currentPageId]},a.prototype.setCurrentPage=function(a){return this.currentPageId=a,this},a.prototype.getApplication=function(){return this.application},Eiw.page.container=a}(),function(){"use strict";var a;a=function(){this.router=null,this.widgets=null,this.pages=null,this.logger=null,this.requestManager=null},$.extend(!0,a.prototype,new Eiw.Widget.Abstract),a.prototype.bootstrap=function(){this.application=this,this.logger=new Eiw.logger,this.logger.log("Application boostraping"),this.requestManager=new Eiw.Application.requestManager,this.requestManager.bootstrap(),this.router=new Eiw.router(this),this.router.bootstrap(),this.pages=new Eiw.page.container(this),this.widgets=new Eiw.Widget.container(this),Eiw.Widget.Abstract.prototype.bootstrap.call(this),this.router.bindApplicationToUrl(this),this.onPostBootstrap()},a.prototype.requestServer=function(a){this.requestManager.requestServer(a)},a.prototype.start=function(){this.bootstrap(),this.pages.bootstrap(),this.widgets.bootstrap()},a.prototype.getNodeId=function(){return"#"+this.getId()+"-app"},a.prototype.log=function(a){this.logger.log(a)},a.prototype.getRouter=function(){return this.router},a.prototype.getType=function(){return Eiw.Widget.types.application},a.prototype.onPostBootstrap=function(){},a.prototype.onPostLoad=function(){},Eiw.Application.Abstract=a}(),function(){"use strict";var a;a=function(){},a.prototype.bootstrap=function(){},a.prototype.store=function(){return this},a.prototype.test=function(){return!1},a.prototype.getRequestAnswer=function(){return new Eiw.Application.response("test content")},Eiw.Application.cache=a}(),function(){"use strict";var a;a=function(){this.successCallback=null,this.failCallback=null},a.prototype.callSuccess=function(){return null!==this.successCallback&&this.successCallback(),this},a.prototype.success=function(a){return this.successCallback=a},a.prototype.callFail=function(){return null!==this.failCallback&&this.failCallback(),this},a.prototype.fail=function(a){return this.failCallback=a},Eiw.Application.Promise=a}(),function(){"use strict";var a;a=function(a,b,c){this.url=a,this.response=null,this.successCallback=null,void 0!==b&&(this.successCallback=b),this.failCallback=null,void 0!==c&&(this.failCallback=c)},a.prototype.bootstrap=function(){},a.prototype.isCachable=function(){return!0},a.prototype.getUrl=function(){return this.url},a.prototype.getParameters=function(){return{}},a.prototype.setAnswer=function(a){return this.response=a,this},a.prototype.getAnswer=function(){if(null==this.response)throw"No answer have be bound to this request";return this.response},a.prototype.getSuccessCallback=function(){return this.successCallback},a.prototype.getFailCallback=function(){return this.failCallback},Eiw.Application.request=a}(),function(){"use strict";var a;a=function(){this.cache=null},a.prototype.bootstrap=function(){this.cache=new Eiw.Application.cache},a.prototype.requestServer=function(a){var b=this;if(this.cache.test(a)){var c=this.cache.getRequestAnswer(a);a.setAnswer(c),a.getSuccessCallback()(c)}else $.getJSON(a.getUrl(),a.getParameters(),function(c){var c=new Eiw.Application.response(c);a.setAnswer(c),a.isCachable()&&b.cache.store(c),a.getSuccessCallback()(c)},a.getFailCallback())},Eiw.Application.requestManager=a}(),function(){"use strict";var a;a=function(a,b){this.content=a,this.request=b},a.prototype.bootstrap=function(){},a.prototype.getContent=function(){return this.content},Eiw.Application.response=a}();